From e122e7ba81d4e2f2e378000e837f6d1f1aa88376 Mon Sep 17 00:00:00 2001
From: syhost <syhost@163.com>
Date: Sat, 15 Mar 2014 01:19:40 +0800
Subject: [PATCH 1/5] add headset for SystemUI

Change-Id: Ic8a0adf1d6343f03eabd365ffd28a100e97043c7
---
 core/res/res/values/config.xml                     |   1 +
 .../res/drawable-xhdpi/stat_sys_headset.png        | Bin 0 -> 473 bytes
 .../res/drawable-xhdpi/stat_sys_headset_mic.png    | Bin 0 -> 1568 bytes
 packages/SystemUI/res/values/cm_strings.xml        |   1 +
 .../statusbar/phone/PhoneStatusBarPolicy.java      |  29 +++++++++++++++++++++
 5 files changed, 31 insertions(+)
 create mode 100755 packages/SystemUI/res/drawable-xhdpi/stat_sys_headset.png
 create mode 100755 packages/SystemUI/res/drawable-xhdpi/stat_sys_headset_mic.png

diff --git a/core/res/res/values/config.xml b/core/res/res/values/config.xml
index 3c43fc0..d306431 100644
--- a/core/res/res/values/config.xml
+++ b/core/res/res/values/config.xml
@@ -45,6 +45,7 @@
        <item><xliff:g id="id">alarm_clock</xliff:g></item>
        <item><xliff:g id="id">secure</xliff:g></item>
        <item><xliff:g id="id">clock</xliff:g></item>
+       <item><xliff:g id="id">headset</xliff:g></item>
     </string-array>
 
     <!-- Flag indicating whether the surface flinger has limited
diff --git a/packages/SystemUI/res/drawable-xhdpi/stat_sys_headset.png b/packages/SystemUI/res/drawable-xhdpi/stat_sys_headset.png
new file mode 100755
index 0000000000000000000000000000000000000000..3cc7cdf030c4d22aae0776c2d92db12d942e1177
GIT binary patch
literal 473
zcmeAS@N?(olHy`uVBq!ia0vp^IzVi|!3-p0{W2~Csk#845ZC_$3O3dB+yc5pt0c%T
zn8Bdy<ir0e>pVVt|5=@8{NbLf)Amc8=Xd>7Y@c9r=DFzGK%O~EpKO^QJ~`^)`h1|S
z2c9mDAs)xyPB~e0$UuOVcbQ?gp*I6358Ihp|NlG2bb3xm;dKq1^T9fE*Dr;$KAIe_
zu2lL<o!#K7ont1q`fW$_qHoOGFF&=v+xOzzuU29HNeYrjj;_2v`JF+_#T`0o$`V}W
zKbu~@SwHKn<Imp=RfXaDCMtH7oGTfFB7Qv)2xE&lcuPHfgW&<TZFW0f%yupCm^pWm
zSD1D9+3)tw#i=)*Z;M&yGSw&LJxf#1R%Q0UKHn;lr;9zeYGkL&HO-m%Mdj3T@m(K7
z<~RR|`8er*`TXMY2jWXN=XWoi88-b_`JXc}jP;YbcW8b)vK;7F22WQ%mvv4FO#uDs
B7dij{

literal 0
HcmV?d00001

diff --git a/packages/SystemUI/res/drawable-xhdpi/stat_sys_headset_mic.png b/packages/SystemUI/res/drawable-xhdpi/stat_sys_headset_mic.png
new file mode 100755
index 0000000000000000000000000000000000000000..f526f9309abcef99f6d712c04cd46458f3ba57dd
GIT binary patch
literal 1568
zcmeAS@N?(olHy`uVBq!ia0vp^DnP8x!3-n=yrftd7??}~d_r7--2bCsGz3Tqfw@8n
zz+}U)rzFTPn1MmbJ|v}VBC}(B&zd9G-~4CcH}1Ic=ZDGsho7Ha+&G6PVcYwKu>tND
z`qzZcU0#}Rn8z3V;nM+L|GQ7yWx1@@zHLyi<!Jl(eWr@Sgl{{~o~gL`sJQS}_4-3<
zOsc=X_A<UGHDZ7HGjzcf=Vgz-h(6!D=>FnK7b>HU9#q~Uyjf%FgI6wFMKYute<`l}
z`_8&XAkb&uzbctk=i^REaB{P5cwL{>+1KP9lcp<}v^>abifw^p#0m$k))UiAS0CT;
zIY{^*Fdy9aba4!^I9)oWGCC+w;Mn<zt}I{W1Og&iR7Hgf8C?Vpaq#G>@=oSZRSon$
zTQ=P*IM`Wx`>8YEa_)bBdb)IHOxc|M&uY)Ve|SzNjgMhs11IC8rVW=hLZobM=lU%U
zx-`i$#`u!aj5TN0<nSo!SZhx{dd4I9NK(bQXHN<$H6;GriLsmbVTYwmnaJVIdukdD
zJUWiB3VAk0h&*X&`m=|FW#N_$9&G{N^r{LySH>)yFnyZH<<I5HD%x68+B7&$XLuda
z4-b7}xM;1R*6NU_HA|LE6%<($mOWvc+uH72^%<|Pm_{uL3>OYqD<}D?M{Nd&<K&I!
z8oq4Z!TEhg;NLj!uG5EgPunpYy>C2_m3<>W-=}oH<C>QT9M_)Z5;?o#=nNr6gT>6I
z+6NY1+je-_T*b-37wT9_Om_6`I@tHn?%5?VhI#H=5AXN8rNz%*!nJ$B^|J-l!kQkp
zVh{N>^pziWTi$Z}v3E<2ZA|B8!Ls=d3&NLu`u_FwtuxF$6&;2Nd6U0>|LLD3Rge|%
zM8WN_nFv4cO^(}!G54AL_!kHCoOrDGlcTcWnU2MA<zjZ@bs8s1Ca^!(Z|I(WBIa1v
zTYjf$JvI`$jLEVoeaF=I1fH-ql>4S1&v<Wj;=(1r7ES11#q(P^j$!WPB{Md?UNqsH
zo$IZ+F?+hQFE9C|k-o^;eDRkFX8B^*uRnk0*{SQ&^+_+`;rhD^SiU;cE2xN1zmeFn
zcZ)<@-aRF;huiE_T&KOzk91Mgzp&4TM`%mfnhZgyk~4*iObegM%nFscv}UdIr$^J?
zzj&W!^wF|okH&>^f74r55;u0pM<#w-_T}I+v7Xik*Os09{^4S>rcc$3S@UdauYLXF
zn!)*STSbjd<(A&iB%j5GKKpByZr-=9X7i_Sv0bsBcRSf~zWMk4w)~N^^1*K(=Tve;
zef@GSJ9fU^=3vM86FWJ#)WvH5+cvLi{r>+m<{UCOd_I25{bg73vp4vkn!mrVw|=wm
a$0PLzKhFqmus1OT<ylWxKbLh*2~7axoeM+&

literal 0
HcmV?d00001

diff --git a/packages/SystemUI/res/values/cm_strings.xml b/packages/SystemUI/res/values/cm_strings.xml
index 6366ccc..2573ab7 100644
--- a/packages/SystemUI/res/values/cm_strings.xml
+++ b/packages/SystemUI/res/values/cm_strings.xml
@@ -103,4 +103,5 @@
 
     <!-- Content description for the add quick settings tile button. [CHAR LIMIT=NONE] -->
     <string name="accessibility_desc_add_quick_settings">Add Quick settings.</string>
+    <string name="headset_enabled">Headset Enabled.</string>
 </resources>
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
index 6d39ea5..2180240 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
@@ -103,6 +103,9 @@ public class PhoneStatusBarPolicy {
             else if (action.equals(TtyIntent.TTY_ENABLED_CHANGE_ACTION)) {
                 updateTTY(intent);
             }
+            else if (action.equals(Intent.ACTION_HEADSET_PLUG)) {
+                updateHeadset(intent);
+            }
         }
     };
 
@@ -119,6 +122,7 @@ public class PhoneStatusBarPolicy {
         filter.addAction(BluetoothAdapter.ACTION_CONNECTION_STATE_CHANGED);
         filter.addAction(TelephonyIntents.ACTION_SIM_STATE_CHANGED);
         filter.addAction(TtyIntent.TTY_ENABLED_CHANGE_ACTION);
+        filter.addAction(Intent.ACTION_HEADSET_PLUG);
         mContext.registerReceiver(mIntentReceiver, filter, null, mHandler);
 
         int numPhones = MSimTelephonyManager.getDefault().getPhoneCount();
@@ -276,4 +280,29 @@ public class PhoneStatusBarPolicy {
             mService.setIconVisibility("tty", false);
         }
     }
+
+    private final void updateHeadset(Intent intent) {
+        final String action = intent.getAction();
+        final int state = intent.getIntExtra("state", 4);
+        final int mic = intent.getIntExtra("microphone", 4);
+        
+        switch (state) {
+        case 0:
+            try{
+                mService.setIconVisibility("headset", false);
+            } catch (Exception e) {
+                //Log.i("StatusBar Headset", "frist time to run");
+                }
+        break;
+        case 1:
+            if (mic == 1)
+                mService.setIcon("headset", R.drawable.stat_sys_headset_mic, 0,
+                    mContext.getResources().getString(R.string.headset_enabled));
+            else                                    
+                mService.setIcon("headset", R.drawable.stat_sys_headset, 0,
+                    mContext.getResources().getString(R.string.headset_enabled));
+            mService.setIconVisibility("headset", true);
+        break;
+        }
+    }
 }
-- 
1.8.3.2

